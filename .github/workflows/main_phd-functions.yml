name: Build and deploy Node.js project to Azure Function App - phd-functions

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: 'phd-helper-functions-hwgefgecf9gjced3'
  AZURE_RESOURCE_GROUP: 'phdhelper-AUeast'
  NODE_VERSION: '20.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install --production

      - name: Create deployment package
        run: zip -r deploy.zip . -x "*.git*" ".github/*" "*.md" "scripts/*"

      - name: Deploy to Azure Functions via Kudu
        env:
          PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
        run: |
          # Extract credentials from publish profile
          USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP 'userName="\K[^"]+' | head -1)
          PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP 'userPWD="\K[^"]+' | head -1)
          PUBLISH_URL=$(echo "$PUBLISH_PROFILE" | grep -oP 'publishUrl="\K[^"]+' | head -1)
          PUBLISH_HOST=${PUBLISH_URL%%:*}
          export USERNAME
          export PASSWORD
          export PUBLISH_HOST
          KUDU_URL="https://${PUBLISH_HOST}/api/zipdeploy"
          SETTINGS_URL="https://${PUBLISH_HOST}/api/settings"
          DEPLOYMENTS_URL="https://${PUBLISH_HOST}/api/deployments"
          
          echo "Deploying to $KUDU_URL..."

          echo "Preflight: checking Kudu settings for WEBSITE_RUN_FROM_PACKAGE..."
          python - <<'PY'
          import json, os, sys, urllib.request, base64
          host = os.environ.get('PUBLISH_HOST')
          user = os.environ.get('USERNAME')
          pwd = os.environ.get('PASSWORD')
          url = f"https://{host}/api/settings"
          req = urllib.request.Request(url)
          token = base64.b64encode(f"{user}:{pwd}".encode()).decode()
          req.add_header('Authorization', f'Basic {token}')
          with urllib.request.urlopen(req) as r:
              data = json.loads(r.read().decode())
          v = data.get('WEBSITE_RUN_FROM_PACKAGE') or data.get('WEBSITE_USE_ZIP')
          if not v:
              print('WEBSITE_RUN_FROM_PACKAGE/WEBSITE_USE_ZIP: (not set)')
          else:
              s = str(v)
              # Redact URL/token contents but keep enough to diagnose
              if s.startswith('http'):
                  print('WEBSITE_RUN_FROM_PACKAGE/WEBSITE_USE_ZIP: (set to remote URL)')
              else:
                  print(f'WEBSITE_RUN_FROM_PACKAGE/WEBSITE_USE_ZIP: {s}')
          PY


          echo "Preflight: checking for in-progress deployments..."
          # Kudu returns 409 frequently when a deployment is already running.
          # Poll deployments for up to 2 minutes to let any existing deployment finish.
          for i in {1..24}; do
            IN_PROGRESS=$(curl -sS --user "$USERNAME:$PASSWORD" "$DEPLOYMENTS_URL" | grep -E '"status"\s*:\s*3' || true)
            if [ -z "$IN_PROGRESS" ]; then
              echo "No in-progress deployments detected."
              break
            fi
            echo "Deployment in progress detected; waiting 5s..."
            sleep 5
          done
          
          # Deploy using curl with basic auth
          # Kudu may return 202 with an async deployment, or 409 if a deployment is running.
          DEPLOY_ACCEPTED=0
          for attempt in 1 2 3 4 5; do
            echo "ZipDeploy attempt $attempt..."
            HTTP_CODE=$(curl -X POST "$KUDU_URL" \
              --user "$USERNAME:$PASSWORD" \
              --header "Content-Type: application/zip" \
              --data-binary @deploy.zip \
              --silent \
              --show-error \
              --output kudu_response.txt \
              --write-out "%{http_code}")
            echo "HTTP Status: $HTTP_CODE"
            echo "Kudu response body:"
            cat kudu_response.txt || true
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "202" ]; then
              echo "ZipDeploy accepted."
              DEPLOY_ACCEPTED=1
              break
            fi
            if [ "$HTTP_CODE" = "409" ]; then
              echo "Got 409 Conflict (likely deployment in progress). Waiting 10s then retrying..."
              sleep 10
              continue
            fi
            echo "ZipDeploy failed with status $HTTP_CODE"
            exit 1
          done

          if [ "$DEPLOY_ACCEPTED" != "1" ]; then
            echo "Deployment NOT accepted by Kudu after retries."
            exit 1
          fi

          echo "Deployment accepted by Kudu."