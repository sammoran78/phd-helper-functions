name: Build and deploy Node.js project to Azure Function App - phd-functions

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: 'phd-helper-functions-hwgefgecf9gjced3'
  AZURE_RESOURCE_GROUP: 'phdhelper-AUeast'
  NODE_VERSION: '20.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install --production

      - name: Create deployment package
        run: zip -r deploy.zip . -x "*.git*" ".github/*" "*.md" "scripts/*"

      - name: Deploy to Azure Functions via Kudu
        env:
          PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
        run: |
          # Extract credentials from publish profile
          USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP 'userName="\K[^"]+' | head -1)
          PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP 'userPWD="\K[^"]+' | head -1)
          PUBLISH_URL=$(echo "$PUBLISH_PROFILE" | grep -oP 'publishUrl="\K[^"]+' | head -1)
          PUBLISH_HOST=${PUBLISH_URL%%:*}
          KUDU_URL="https://${PUBLISH_HOST}/api/zipdeploy"
          
          echo "Deploying to $KUDU_URL..."
          
          # Deploy using curl with basic auth
          curl -X POST "$KUDU_URL" \
            --user "$USERNAME:$PASSWORD" \
            --header "Content-Type: application/zip" \
            --data-binary @deploy.zip \
            --fail \
            --show-error \
            --silent \
            --output /dev/null \
            --write-out "HTTP Status: %{http_code}\n"
          
          echo "Deployment complete!"